name: Release Helm chart to GHCR

on:
  push:
    branches:
      - main
    tags:
      - '*'

permissions:
  contents: read
  packages: write

env:
  UPSTREAM_REPO_URL: https://git.deuxfleurs.fr/Deuxfleurs/garage.git
  CHART_PATH: script/helm/garage
  CHART_NAME: garage
  OCI_NAMESPACE: ghcr.io/${{ github.repository_owner }}/helm

jobs:
  release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout this repo
        uses: actions/checkout@v4

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: v3.14.0

      - name: Log in to GHCR
        run: |
          echo "${{ secrets.GITHUB_TOKEN }}" | \
            helm registry login ghcr.io \
              --username ${{ github.actor }} \
              --password-stdin

      # Clone upstream at tag (appVersion)
      - name: Clone upstream repo at tag
        if: github.ref_type == 'tag'
        run: |
          git clone --depth 1 \
            --branch ${{ github.ref_name }} \
            $UPSTREAM_REPO_URL upstream

      # Clone upstream default branch (main case)
      - name: Clone upstream repo (default branch)
        if: github.ref_type == 'branch'
        run: |
          git clone --depth 1 \
            $UPSTREAM_REPO_URL upstream

      - name: Read chart version from Chart.yaml
        run: |
          CHART_VERSION=$(grep '^version:' upstream/${{ env.CHART_PATH }}/Chart.yaml | awk '{print $2}')
          echo "CHART_VERSION=$CHART_VERSION" >> $GITHUB_ENV
          echo "Detected chart version: $CHART_VERSION"

      - name: Package Helm chart
        run: |
          helm dependency build upstream/${{ env.CHART_PATH }}
          helm package upstream/${{ env.CHART_PATH }}

      - name: Push chart to OCI registry
        if: github.ref_type == 'tag'
        run: |
          helm push \
            ${{ env.CHART_NAME }}-${{ env.CHART_VERSION }}.tgz \
            oci://${{ env.OCI_NAMESPACE }}
